<!-- Javascript libs -->
<script src="/js/vendor/backbone.iosync.js"></script>
<script src="/js/vendor/backbone.iobind.js"></script>
<!-- ******************************** -->
<!-- FileUpload -->
<script type="text/javascript" src="js/vendor/jquery.fileDownload.js"></script>
<!-- ******************************** -->
<!-- CKEditor -->
<script src="/js/ckeditor/ckeditor.js"></script>
<!-- Templates to load -->
<%- partial('../app/templates/topbar_templates') %>
<%- partial('../app/templates/title_templates') %>
<%- partial('templates/explorer_template') %>
<%- partial('../app/templates/modelEditor_templates') %>
<%- partial('../app/templates/comments_templates') %>
<%- partial('../app/templates/attachment_templates') %>
<%- partial('../app/templates/CKLayout_templates') %>
<%- partial('../app/templates/conceptsList_templates') %>
<%- partial('../app/templates/expertsList_templates') %>
<%- partial('../app/templates/categoriesList_templates') %>
<%- partial('../app/templates/projectsList_templates') %>
<%- partial('../app/templates/activitiesList_templates') %>
<!-- Modules situÃ©s dans assets/js/BB_app -->
<script type="text/javascript" src="js/BB_app/modules/modelEditor.js"></script>
<script type="text/javascript" src="js/BB_app/modules/comments.js"></script>
<script type="text/javascript" src="js/BB_app/modules/attachment.js"></script>
<script type="text/javascript" src="js/BB_app/modules/CKLayout.js"></script>
<script type="text/javascript" src="js/BB_app/modules/topbar.js"></script>
<script type="text/javascript" src="js/BB_app/modules/explorer.js"></script>
<script type="text/javascript" src="js/BB_app/modules/title.js"></script>
<script type="text/javascript" src="js/BB_app/modules/conceptsList.js"></script>
<script type="text/javascript" src="js/BB_app/modules/expertsList.js"></script>
<script type="text/javascript" src="js/BB_app/modules/categoriesList.js"></script>
<script type="text/javascript" src="js/BB_app/modules/projectsList.js"></script>
<script type="text/javascript" src="js/BB_app/modules/activitiesList.js"></script>

<script>
  ///////////////////////////////////////////////////
  $(document).ready(function () {
    console.log( "CreaKtive DOM loaded!" );
    ////////////////////////////////////////
    Backbone.Model.prototype.toJSON = function() {
      return JSON.parse(JSON.stringify(this.attributes));
    };
    ////////////////////////////////////////
    rt(io, function(){
      var project = <%- currentProject %>;
      var users = <%- users %>;
      var knowledges = <%- knowledges %>;
      var projects = <%- projects %>;
      var poches = <%- poches %>;
      var concepts = <%- concepts %>;
      var links = <%- links %>;
      var notifications = <%- notifications %>;
      var permissions = <%- permissions %>;

      _.each(knowledges, function(k){
        k.comments = new global.Collections.Comments(k.comments);
        k.members = new global.Collections.UsersCollection(k.members);
      })
      _.each(concepts, function(c){
        c.comments = new global.Collections.Comments(c.comments);
        c.members = new global.Collections.UsersCollection(c.members);
      })

      global.init('<%- currentUser %>', project, users, knowledges, poches, projects, concepts, links, notifications, permissions, function(){
        // Modules
        title.init(<%- currentProject %>,"knowledge");
        topbar.init();
        explorer.init();
        /*activat of "hashchange events's monitoring"*/
        Backbone.history.start();  
      });
    });

  });
  /////////////////////////////////////////////////////////////////////////////////////////////
  // Realtime connection
  /////////////////////////////////////////////////////////////////////////////////////////////
  function rt (io, callback) {
    // as soon as this file is loaded, connect automatically, 
    var socket = io.connect("/",{'sync disconnect on unload ': true});
    socket.on('connect', function socketConnected() {
      socket.get("/auth/openChannels", function(data){
        // console.log(data.msg);
        // console.log(data.channels);
      });
      console.log(
        'Socket is now connected and globally accessible as `socket`.\n' + 
        'e.g. to send a GET request to Sails, try \n' + 
        '`socket.get("/", function (response) ' +
          '{ console.log(response); })`'
      );
      callback();
    });
    window.socket = socket;
  };
</script>



